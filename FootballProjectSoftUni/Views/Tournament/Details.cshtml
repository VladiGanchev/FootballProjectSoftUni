@using FootballProjectSoftUni.Core.Models.Tournament;
@using FootballProjectSoftUni.Extensions
@using FootballProjectSoftUni.Infrastructure.Data.Enums;
@model DetailsViewModel

@{
    ViewBag.Title = "Tournament Details";
}

<section class="container py-4">

    @* Header *@
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-end gap-3 mb-4">
        <div>
            <h2 class="page-title mb-1">
                <i class="bi bi-trophy-fill me-2"></i>
                @ViewBag.Title
            </h2>
            <p class="text-muted mb-0">
                Детайли за турнира, участници и схема с мачове по рундове.
            </p>
        </div>
    </div>

    @* Main details card *@
    <div class="tournament-details-card">
        <div class="row g-4 justify-content-center">

            <div class="col-12 col-lg-8">
                <h3 class="fw-bold mb-3">
                    <i class="bi bi-card-text me-2"></i>@Model.Description
                </h3>

                <div class="details-grid">
                    <div class="details-item">
                        <i class="bi bi-calendar-event-fill me-2"></i>
                        <span class="fw-bold me-1">Starting Time:</span> @Model.StartDate
                    </div>

                    <div class="details-item">
                        <i class="bi bi-calendar-check-fill me-2"></i>
                        <span class="fw-bold me-1">Ending Time:</span> @Model.EndDate
                    </div>

                    <div class="details-item">
                        <i class="bi bi-clock-history me-2"></i>
                        <span class="fw-bold me-1">Created On:</span> @Model.CreatedOn
                    </div>

                    <div class="details-item">
                        <i class="bi bi-people-fill me-2"></i>
                        <span class="fw-bold me-1">Number Of Teams:</span> @Model.NumberOfTeams
                    </div>

                    <div class="details-item">
                        <i class="bi bi-whistle-fill me-2"></i>
                        <span class="fw-bold me-1">Referee:</span> @Model.RefereeName
                    </div>

                    <div class="details-item">
                        <i class="bi bi-receipt-cutoff me-2"></i>
                        <span class="fw-bold me-1">Participation Fee:</span>
                        @Model.ParticipationFee.ToString("C2", new System.Globalization.CultureInfo("de-DE"))
                    </div>

                    <div class="details-item">
                        <i class="bi bi-cash-coin me-2"></i>
                        <span class="fw-bold me-1">Prize:</span>
                        @Model.Prize.ToString("C2", new System.Globalization.CultureInfo("de-DE"))
                    </div>

                    <div class="details-item">
                        <i class="bi bi-activity me-2"></i>
                        <span class="fw-bold me-1">Status:</span>
                        @{
                            if (Model.StartDate > DateTime.Now)
                            {
                                <span class="tournament-status status-upcoming ms-2">
                                    <i class="bi bi-clock-fill me-1"></i>@TournamentStatus.Upcoming
                                </span>
                            }
                            else if (DateTime.Now > Model.StartDate && DateTime.Now < Model.EndDate)
                            {
                                <span class="tournament-status status-started ms-2">
                                    <i class="bi bi-play-fill me-1"></i>@TournamentStatus.Started
                                </span>
                            }
                            else if (DateTime.Now > Model.EndDate)
                            {
                                <span class="tournament-status status-finished ms-2">
                                    <i class="bi bi-flag-fill me-1"></i>@TournamentStatus.Finished
                                </span>
                            }
                        }
                    </div>
                </div>

                <div class="participants-box mt-3">
                    <div class="fw-bold mb-1">
                        <i class="bi bi-diagram-3-fill me-2"></i>Participants
                    </div>

                    <div class="text-muted">
                        @if (Model.ParticipantTeams != null && Model.ParticipantTeams.Any())
                        {
                            @string.Join(", ", Model.ParticipantTeams)
                        }
                        else
                        {
                            @:No teams registered yet.
                        }
                    </div>
                </div>

                @if (!string.IsNullOrWhiteSpace(Model.Winner))
                {
                    <div class="winner-box mt-3">
                        <div class="fw-bold">
                            <i class="bi bi-award-fill me-2"></i>Winner
                        </div>
                        <div class="fw-semibold">@Model.Winner</div>
                    </div>
                }

                @* Actions moved under the descriptions *@
                <div class="details-actions mt-4 d-grid gap-2">
                    <a asp-controller="Tournament"
                       asp-action="CityTournaments"
                       asp-route-id="@Model.CityId"
                       class="btn btn-warning btn-lg w-100 fw-bold tg-action-btn">
                        <i class="bi bi-geo-alt-fill me-2"></i>
                        Back to All Tournaments
                    </a>

                    @if (User.IsAdmin())
                    {
                        <a asp-controller="Tournament"
                           asp-action="Edit"
                           asp-route-id="@Model.Id"
                           class="btn btn-outline-dark btn-lg w-100 fw-bold tg-action-btn">
                            <i class="bi bi-pencil-square me-2"></i>
                            Edit
                        </a>
                    }
                </div>
            </div>

            @* Right column removed on purpose (actions are now under details) *@

        </div>
    </div>

    @* Bracket / Matches *@
    @if (Model.Matches != null && Model.Matches.Any())
    {
        <div class="mt-5">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
                <h3 class="mb-0 fw-bold">
                    <i class="bi bi-diagram-3-fill me-2"></i>
                    Схема на турнира
                </h3>
                <span class="text-muted small">
                    Групирано по рундове
                </span>
            </div>

            @foreach (var roundGroup in Model.Matches.GroupBy(m => m.Round).OrderBy(g => g.Key))
            {
                <div class="round-card mt-3">
                    <div class="round-head">
                        <h5 class="mb-0 fw-bold">
                            <i class="bi bi-layers-fill me-2"></i>Рунд @roundGroup.Key
                        </h5>
                    </div>

                    <div class="table-responsive">
                        <table class="table align-middle mb-0 tg-table">
                            <thead>
                                <tr>
                                    <th class="text-center">Отбор 1</th>
                                    <th class="text-center">Резултат</th>
                                    <th class="text-center">Отбор 2</th>
                                    <th class="text-center">Победител</th>
                                    <th class="text-center"></th>
                                </tr>
                            </thead>

                            <tbody>
                                @foreach (var match in roundGroup)
                                {
                                    <tr>
                                        <td class="text-center fw-semibold">@match.Team1Name</td>

                                        <td class="text-center">
                                            @if (match.Team1Goals.HasValue && match.Team2Goals.HasValue)
                                            {
                                                <span class="score-pill">
                                                    @($"{match.Team1Goals}:{match.Team2Goals}")
                                                </span>
                                            }
                                            else
                                            {
                                                @: -
                                            }
                                        </td>

                                        <td class="text-center fw-semibold">@match.Team2Name</td>

                                        <td class="text-center">
                                            @if (!string.IsNullOrEmpty(match.WinnerTeamName))
                                            {
                                                <span class="winner-pill">
                                                    <i class="bi bi-trophy-fill me-1"></i>@match.WinnerTeamName
                                                </span>
                                            }
                                            else
                                            {
                                                @: -
                                            }
                                        </td>

                                        <td class="text-center">
                                            @if (User.IsAdmin()
                                                                            && match.Team1Id.HasValue
                                                                            && match.Team2Id.HasValue)
                                            {
                                                <a asp-controller="Match"
                                                   asp-action="EnterResult"
                                                   asp-route-id="@match.Id"
                                                   class="btn btn-sm btn-primary">
                                                    <i class="bi bi-pencil-square me-1"></i>
                                                    Въведи / редактирай резултат
                                                </a>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>

                        </table>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="empty-state text-center mt-4">
            <i class="bi bi-diagram-2 display-4 text-muted"></i>
            <h5 class="mt-3">Все още няма схема за този турнир</h5>
            <p class="text-muted mb-0">Когато се генерират мачове, ще се появят тук.</p>
        </div>
    }

</section>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
